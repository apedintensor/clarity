# Implementation Plan: Fix Calendar UX

**Branch**: `006-fix-calendar-ux` | **Date**: 2026-02-15 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/006-fix-calendar-ux/spec.md`

## Summary

Fix five calendar UX issues: (1) missing unscheduled tasks in sidebar due to goal.list query filtering, (2) week view starting on Monday instead of today, (3) no drag-to-unschedule from calendar back to sidebar, (4) destructive "Delete" in context menu replaced with "Remove from Calendar", (5) unreadable calendar text in dark mode.

## Technical Context

**Language/Version**: TypeScript 5.6+ (strict mode)
**Primary Dependencies**: Next.js 15 (App Router), tRPC v11, FullCalendar v6, Drizzle ORM
**Storage**: SQLite (better-sqlite3)
**Testing**: Manual validation (quickstart scenarios)
**Target Platform**: Web (localhost)
**Project Type**: Monorepo (pnpm workspaces)
**Performance Goals**: <200ms p95 for non-AI API calls
**Constraints**: Local-first single user, FullCalendar API for drag/drop

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Gate | Status |
|-----------|------|--------|
| I. Monorepo Package Isolation | Changes stay within `web` and `core` packages | PASS |
| II. Shared Core via tRPC | Unschedule logic uses existing `task.unschedule` tRPC procedure | PASS |
| III. Type Safety First | No new types needed; using existing task/goal types | PASS |
| IV. Local-First Single User | All changes are local, no new external dependencies | PASS |
| V. Spec-Driven Development | Spec and plan created before implementation | PASS |

## Project Structure

### Documentation (this feature)

```text
specs/006-fix-calendar-ux/
├── plan.md              # This file
├── research.md          # FullCalendar drag-out and dark mode research
├── quickstart.md        # Test scenarios
└── tasks.md             # Task list (generated by /speckit.tasks)
```

### Source Code (files modified)

```text
packages/web/src/
├── components/
│   ├── calendar-view.tsx        # US2: firstDay→today, US3: drag-out, US4: context menu, US5: dark mode CSS
│   └── calendar-sidebar.tsx     # US1: fix missing tasks, US3: drop zone for unschedule
├── app/
│   └── calendar/
│       └── page.tsx             # US2: dynamic date range from today
└── styles/
    └── globals.css              # US5: FullCalendar dark mode overrides
```

**Structure Decision**: All changes are UI-side in `packages/web`. The `task.unschedule` tRPC procedure already exists in `packages/core/src/router/task.ts` and will be reused. No new files needed — only modifications to existing files.

## Root Cause Analysis

### US1: Missing unscheduled tasks
The sidebar uses `trpc.goal.list.useQuery({ userId, status: "active" })` which returns `goal.tasks` — all non-deleted tasks. The sidebar filters to `!t.scheduledDate && !t.deletedAt && t.status !== "completed" && t.status !== "skipped"`. This should show all unscheduled tasks. Likely cause: the `goal.list` query returns tasks ordered by `sortOrder`, and a task may have been created without proper `sortOrder`, or `parentTaskId` filtering is accidentally excluding subtasks. Need to verify the data and filter logic.

### US2: Today not first column
Current config has `firstDay={1}` (Monday). This is a FullCalendar setting that sets the week start day. To always start on today, we need to use `initialDate={today}` and set `firstDay` to today's day-of-week dynamically. The page.tsx also calculates a Monday-based date range which needs to start from today.

### US3: Drag events back to sidebar
FullCalendar supports `eventDragStop` callback which fires when an event drag ends (even outside the calendar). We can detect if the drop target is the sidebar area and call `task.unschedule` to clear the schedule fields. The event should also be reverted from the calendar.

### US4: Context menu "Delete" → "Remove from Calendar"
Simple label change + swap the action from `softDeleteMut` to `unscheduleMut` (using the existing `task.unschedule` procedure). Remove the undo toast since unschedule is not destructive.

### US5: Dark mode calendar
FullCalendar renders its own DOM with inline styles and CSS classes. The `.dark` CSS variables are set, but FullCalendar's default styles use hardcoded colors. Need to add CSS overrides for `.dark .fc-*` selectors in globals.css.
